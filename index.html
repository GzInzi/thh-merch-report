<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>THH Merchandising Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    html, body { width:100vw; margin:0; padding:0; }
    table th, table td { white-space: nowrap; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <!-- Toast & Spinner -->
  <div id="toast" class="fixed bottom-5 right-5 hidden bg-gray-800 text-white px-4 py-2 rounded shadow"></div>
  <div id="spinnerOverlay" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center hidden">
    <div class="border-8 border-gray-200 border-t-8 border-t-blue-600 rounded-full w-16 h-16 animate-spin"></div>
  </div>

  <!-- Header -->
  <header class="bg-white shadow">
    <div class="container mx-auto px-4 py-4">
      <h1 class="text-3xl font-bold text-center">THH Merchandising Report</h1>
    </div>
  </header>

  <main class="container mx-auto px-4 py-6 space-y-8">

    <!-- Data Entry -->
    <section class="bg-white p-6 rounded-lg shadow">
      <h2 class="text-2xl font-semibold mb-4">Data Entry</h2>
      <form id="entryForm" class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <input id="vin"     placeholder="VIN Number"          class="border p-3 rounded w-full"/>
        <input id="stock"   placeholder="Stock Number"        class="border p-3 rounded w-full"/>
        <input id="make"    placeholder="Make"                 class="border p-3 rounded w-full"/>
        <input id="model"   placeholder="Model"                class="border p-3 rounded w-full"/>
        <select id="year"   class="border p-3 rounded w-full"><option value="">Year</option></select>
        <input id="date"    type="date"                       class="border p-3 rounded w-full"/>
        <input id="comment" placeholder="Comment (Optional)"   class="border p-3 rounded w-full"/>
        <div class="md:col-span-4 text-right">
          <button type="button" onclick="addPending()"
                  class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded shadow">
            Add to Pending
          </button>
        </div>
      </form>
    </section>

    <!-- Pending Vehicles -->
    <section class="bg-white p-6 rounded-lg shadow">
      <h2 class="text-2xl font-semibold mb-4">Pending Vehicles</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white table-auto">
          <thead class="bg-gray-100">
            <tr class="text-left text-gray-600 uppercase text-sm">
              <th class="px-4 py-2 border">VIN</th>
              <th class="px-4 py-2 border">Stock</th>
              <th class="px-4 py-2 border">Make</th>
              <th class="px-4 py-2 border">Model</th>
              <th class="px-4 py-2 border">Year</th>
              <th class="px-4 py-2 border">Date</th>
              <th class="px-4 py-2 border">Comment</th>
              <th class="px-4 py-2 border text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="pendingTable" class="divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </section>

    <!-- Completed Vehicles -->
    <section class="bg-white p-6 rounded-lg shadow">
      <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4">
        <h2 class="text-2xl font-semibold">Completed Vehicles</h2>
        <input id="searchCompleted" type="text" placeholder="Search VIN, Stock, Make…"
               class="border p-3 rounded w-full md:w-1/3 mt-4 md:mt-0"/>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white table-auto">
          <thead class="bg-gray-100">
            <tr class="text-left text-gray-600 uppercase text-sm">
              <th class="px-4 py-2 border">VIN</th>
              <th class="px-4 py-2 border">Stock</th>
              <th class="px-4 py-2 border">Make</th>
              <th class="px-4 py-2 border">Model</th>
              <th class="px-4 py-2 border">Year</th>
              <th class="px-4 py-2 border">Date</th>
              <th class="px-4 py-2 border">Detailed</th>
              <th class="px-4 py-2 border">Photos</th>
              <th class="px-4 py-2 border">Half Reason</th>
              <th class="px-4 py-2 border">Comment</th>
              <th class="px-4 py-2 border text-center">Days</th>
              <th class="px-4 py-2 border text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="completedTable" class="divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- Complete Modal -->
  <div id="completeModal"
       class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg p-6 w-11/12 max-w-md">
      <button class="close-button float-right text-gray-500 hover:text-gray-800"
              onclick="closeCompleteModal()">&times;</button>
      <h3 class="text-xl font-semibold mb-4">Complete Vehicle</h3>
      <div class="mb-4">
        <label class="block mb-1">Detailed?</label>
        <select id="completeDetailed" class="border p-2 rounded w-full">
          <option value="">Select…</option>
          <option>Yes</option><option>No</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="block mb-1">Photos?</label>
        <select id="completePhotoType" class="border p-2 rounded w-full">
          <option value="">Select…</option>
          <option>Full Photos</option><option>Half Photos</option>
        </select>
      </div>
      <div id="halfReasonContainer" class="mb-4 hidden">
        <label class="block mb-1">Reason for half photographs</label>
        <textarea id="completeHalfReason" class="border p-2 rounded w-full" rows="3"></textarea>
      </div>
      <div class="text-right">
        <button onclick="confirmComplete()"
                class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded">
          Submit
        </button>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div id="editModal"
       class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg p-6 w-11/12 max-w-md">
      <button class="close-button float-right text-gray-500 hover:text-gray-800"
              onclick="closeModal()">&times;</button>
      <h3 class="text-xl font-semibold mb-4">Edit Vehicle Entry</h3>
      <input type="hidden" id="editId"/><input type="hidden" id="editCollection"/>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <input id="editVin"    placeholder="VIN"    class="border p-2 rounded w-full"/>
        <input id="editStock"  placeholder="Stock"  class="border p-2 rounded w-full"/>
        <input id="editMake"   placeholder="Make"   class="border p-2 rounded w-full"/>
        <input id="editModel"  placeholder="Model"  class="border p-2 rounded w-full"/>
        <select id="editYear"  class="border p-2 rounded w-full"><option value="">Year</option></select>
        <input id="editDate"   type="date"         class="border p-2 rounded w-full"/>
        <select id="editDetailed" class="border p-2 rounded w-full">
          <option value="">Detailed?</option><option>Yes</option><option>No</option>
        </select>
        <select id="editPhotoType" class="border p-2 rounded w-full">
          <option value="">Photos?</option><option>Full Photos</option><option>Half Photos</option>
        </select>
      </div>
      <textarea id="editComment"
                class="border p-2 rounded w-full mb-4"
                rows="3" placeholder="Comment"></textarea>
      <div class="text-right">
        <button id="saveEditBtn"
                class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded">
          Save Changes
        </button>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC-hy3eteka35c3ZkLl7exTQ0nnFz9xhFU",
      authDomain: "thh-merch-report.firebaseapp.com",
      projectId: "thh-merch-report",
      storageBucket: "thh-merch-report.appspot.com",
      messagingSenderId: "214148544505",
      appId: "1:214148544505:web:ef4889d43b8189f5146f28"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // UI Helpers
    const spinner = document.getElementById('spinnerOverlay');
    const toast   = document.getElementById('toast');
    function showSpinner(){ spinner.classList.remove('hidden'); }
    function hideSpinner(){ spinner.classList.add('hidden'); }
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.remove('hidden');
      setTimeout(()=> toast.classList.add('hidden'), 3000);
    }

    // Populate year dropdowns
    document.querySelectorAll('#year,#editYear').forEach(sel=>{
      for(let y=2000; y<=new Date().getFullYear(); y++){
        sel.append(new Option(y, y));
      }
    });

    let pendingData = [], completedData = [], currentCompleteId = null;

    // Add to pending
    async function addPending(){
      const vin     = document.getElementById('vin').value.trim(),
            stock   = document.getElementById('stock').value.trim(),
            make    = document.getElementById('make').value.trim(),
            model   = document.getElementById('model').value.trim(),
            year    = document.getElementById('year').value,
            date    = document.getElementById('date').value,
            comment = document.getElementById('comment').value.trim();
      if(!vin||!stock||!make||!model||!year||!date){
        showToast('Please fill all required fields');
        return;
      }
      showSpinner();
      try {
        await db.collection('pending_vehicles').add({vin,stock,make,model,year,date,comment});
        showToast('Added to pending');
        ['vin','stock','make','model','year','date','comment']
          .forEach(id=>document.getElementById(id).value='');
      } catch(e){
        console.error(e);
        showToast('Error adding');
      } finally {
        hideSpinner();
      }
    }

    // Render pending
    function renderPending(data=pendingData){
      const tb = document.getElementById('pendingTable');
      tb.innerHTML = '';
      if(!data.length){
        tb.innerHTML = '<tr><td colspan="8" class="p-4 text-center">No pending vehicles</td></tr>';
        return;
      }
      data.forEach(doc=>{
        const d = doc.data;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-2 border">${d.vin}</td>
          <td class="p-2 border">${d.stock}</td>
          <td class="p-2 border">${d.make}</td>
          <td class="p-2 border">${d.model}</td>
          <td class="p-2 border">${d.year}</td>
          <td class="p-2 border">${d.date}</td>
          <td class="p-2 border">${d.comment||'-'}</td>
          <td class="p-2 border flex space-x-2">
            <button onclick="openCompleteModal('${doc.id}')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">Complete</button>
            <button onclick="openEditModal('${doc.id}','pending_vehicles',d)" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded">Edit</button>
            <button onclick="deleteEntry('${doc.id}','pending_vehicles')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">Delete</button>
          </td>`;
        tb.appendChild(tr);
      });
    }

    // Render completed with Days badge
    function renderCompleted(data=completedData){
      const tb = document.getElementById('completedTable');
      tb.innerHTML = '';
      if(!data.length){
        tb.innerHTML = '<tr><td colspan="12" class="p-4 text-center">No completed vehicles</td></tr>';
        return;
      }
      data.forEach(doc=>{
        const d = doc.data;
        const daysInStock = Math.floor((new Date() - new Date(d.date)) / (1000*60*60*24));
        let cls='';
        if(d.photoType==='Half Photos'){
          if(daysInStock>14) cls='bg-red-500 text-white';
          else if(daysInStock>7) cls='bg-green-200 text-green-800';
        }
        const tr = document.createElement('tr');
        tr.className = d.isSold?'opacity-60 line-through':'';
        tr.innerHTML = `
          <td class="p-2 border">${d.vin}</td>
          <td class="p-2 border ${cls}">${d.stock}</td>
          <td class="p-2 border">${d.make}</td>
          <td class="p-2 border">${d.model}</td>
          <td class="p-2 border">${d.year}</td>
          <td class="p-2 border">${d.date}</td>
          <td class="p-2 border">${d.detailed||'-'}</td>
          <td class="p-2 border">${d.photoType||'-'}</td>
          <td class="p-2 border">${d.halfReason||'-'}</td>
          <td class="p-2 border">${d.comment||'-'}</td>
          <td class="p-2 border text-center">
            <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full">
              ${daysInStock}
            </span>
          </td>
          <td class="p-2 border flex space-x-2">
            <button onclick="openEditModal('${doc.id}','vehicles',d)" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded">Edit</button>
            <button onclick="deleteEntry('${doc.id}','vehicles')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">Delete</button>
            <button onclick="toggleSold('${doc.id}',${d.isSold})" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">${d.isSold?'Undo Sold':'Mark Sold'}</button>
          </td>`;
        tb.appendChild(tr);
      });
    }

    // Modals, edit, delete, toggle, search & Firestore listeners (unchanged)...

    // Open/close complete modal
    document.getElementById('completePhotoType').addEventListener('change', e=>{
      document.getElementById('halfReasonContainer').classList.toggle('hidden', e.target.value!=='Half Photos');
    });
    function openCompleteModal(id){
      currentCompleteId=id;
      document.getElementById('completeModal').classList.remove('hidden');
    }
    function closeCompleteModal(){
      ['completeDetailed','completePhotoType','completeHalfReason'].forEach(i=>document.getElementById(i).value='');
      document.getElementById('halfReasonContainer').classList.add('hidden');
      document.getElementById('completeModal').classList.add('hidden');
    }
    async function confirmComplete(){ /* ... */ }

    function openEditModal(id,coll,data){ /* ... */ }
    function closeModal(){ /* ... */ }
    async function saveEdit(){ /* ... */ }
    async function deleteEntry(id,coll){ /* ... */ }
    async function toggleSold(id,s){ /* ... */ }

    document.getElementById('searchCompleted').addEventListener('input',e=>{
      const v=e.target.value.toLowerCase();
      renderCompleted(completedData.filter(x=>{
        const d=x.data;
        return [d.vin,d.stock,d.make,d.model].some(s=>s.toLowerCase().includes(v));
      }));
    });

    db.collection('pending_vehicles').onSnapshot(s=>{ pendingData=s.docs.map(d=>({id:d.id,data:d.data()})); renderPending(); });
    db.collection('vehicles').onSnapshot(s=>{ completedData=s.docs.map(d=>({id:d.id,data:d.data()})); renderCompleted(); });

    document.getElementById('saveEditBtn').addEventListener('click', saveEdit);
  </script>
</body>
</html>