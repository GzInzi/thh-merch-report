<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>THH Merchandising Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* ======================================================================
           "CLASSIC COMPACT" THEME
        ====================================================================== */
        :root {
            --c-bg: #f8fafc; /* slate-50 */
            --c-surface: #ffffff;
            --c-text-primary: #1e293b; /* slate-800 */
            --c-text-secondary: #64748b; /* slate-500 */
            --c-border: #e2e8f0; /* slate-200 */
            --c-primary: #3b82f6; /* blue-500 */
            --c-primary-hover: #2563eb; /* blue-600 */
            --c-danger: #ef4444; /* red-500 */
            --c-warning: #f59e0b; /* amber-500 */
            --c-success: #22c55e; /* green-500 */
        }

        /* Base */
        body {
            background-color: var(--c-bg);
            font-family: 'Inter', sans-serif;
            color: var(--c-text-primary);
        }

        /* Layout & Cards */
        .card {
            background-color: var(--c-surface);
            border-radius: 0.5rem;
            border: 1px solid var(--c-border);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        /* Buttons (More Compact) */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.375rem 0.75rem; /* Reduced padding */
            border-radius: 0.375rem;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .btn-primary { background-color: var(--c-primary); color: white; }
        .btn-primary:hover { background-color: var(--c-primary-hover); }
        .btn-secondary { background-color: var(--c-surface); color: var(--c-text-primary); border-color: var(--c-border); }
        .btn-secondary:hover { background-color: #f8fafc; } /* slate-50 */
        
        .btn-success { background-color: var(--c-success); color: white; }
        .btn-warning { background-color: var(--c-warning); color: white; }
        .btn-danger { background-color: var(--c-danger); color: white; }

        /* Tables - BORDERED AND COMPACT */
        .custom-table {
            width: 100%;
            border-collapse: collapse; /* Essential for bordered look */
            border: 1px solid var(--c-border); /* Outer border */
        }
        .custom-table th {
            padding: 0.75rem 1rem; /* Reduced padding */
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--c-text-secondary);
            text-transform: uppercase;
            background-color: #f8fafc; /* slate-50 */
            border: 1px solid var(--c-border);
        }
        .custom-table td {
            padding: 0.6rem 1rem; /* Reduced padding */
            font-size: 0.875rem;
            border: 1px solid var(--c-border);
        }
        /* Zebra-striping */
        .custom-table tbody tr:nth-of-type(even) {
            background-color: #f8fafc; /* slate-50 */
        }
        .custom-table tbody tr:hover {
            background-color: #eff6ff; /* blue-50 */
        }
        
        .sortable:hover { background-color: #f1f5f9; cursor: pointer; }
        .sorted-asc::after { content: " ▲"; }
        .sorted-desc::after { content: " ▼"; }

        /* Forms */
        .form-input {
            display: block; width: 100%; border-radius: 0.375rem;
            border: 1px solid var(--c-border); padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }
        .form-input:focus {
            outline: none; border-color: var(--c-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }

        /* Modal */
        .modal-card {
            background-color: var(--c-surface); border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Spinner */
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            animation: spin 1s linear infinite; border-width: 4px;
            border-style: solid; border-color: var(--c-border);
            border-top-color: var(--c-primary); border-radius: 50%;
            width: 3rem; height: 3rem;
        }
    </style>
</head>
<body>
    <div id="spinnerOverlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center hidden z-50">
        <div class="spinner"></div>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 hidden bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg text-sm font-medium"></div>

    <header class="bg-white sticky top-0 z-20 border-b border-gray-200">
        <div class="px-4 sm:px-6 lg:px-8 py-4">
            <h1 class="text-xl font-bold text-gray-900">THH Merchandising Report</h1>
        </div>
    </header>

    <main class="px-4 sm:px-6 lg:px-8 py-8 space-y-8">

        <section class="card p-6">
            <h2 class="text-lg font-semibold mb-4">Data Entry</h2>
            <form class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                <input id="vin" placeholder="VIN Number (Optional)" class="form-input" />
                <input id="stock" placeholder="Stock Number" class="form-input" />
                <span id="stockError" class="text-red-600 text-sm mt-1 hidden col-span-full"></span>
                <input id="make" placeholder="Make" class="form-input" />
                <input id="model" placeholder="Model" class="form-input" />
                <select id="year" class="form-input"><option value="">Year</option></select>
                <input id="date" type="date" class="form-input" />
                <input id="comment" placeholder="Comment (Optional)" class="form-input" />
                <div class="sm:col-span-2 md:col-span-4 text-right mt-2">
                    <button type="button" onclick="addPending()" class="btn btn-primary">Add to Pending</button>
                </div>
            </form>
        </section>

        <section class="card overflow-hidden">
            <div class="p-6">
                <h2 class="text-lg font-semibold">Pending Vehicles</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th data-col="vin" class="sortable">VIN</th>
                            <th data-col="stock" class="sortable">Stock</th>
                            <th data-col="make" class="sortable">Make</th>
                            <th data-col="model" class="sortable">Model</th>
                            <th data-col="year" class="sortable">Year</th>
                            <th data-col="date" class="sortable">Date</th>
                            <th data-col="days" class="sortable text-center">Days</th>
                            <th>Comment</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pendingTable"></tbody>
                </table>
            </div>
            <div class="p-4 flex justify-center items-center space-x-4 bg-slate-50 border-t border-slate-200">
                <button id="pendingPrevBtn" class="btn btn-secondary">Previous</button>
                <span id="pendingPageInfo" class="text-sm text-gray-600"></span>
                <button id="pendingNextBtn" class="btn btn-secondary">Next</button>
            </div>
        </section>

        <section class="card overflow-hidden">
             <div class="p-6 flex flex-col md:flex-row justify-between items-center gap-4">
                <h2 class="text-lg font-semibold">Completed Vehicles</h2>
                <input id="searchCompleted" type="text" placeholder="Search..." class="form-input w-full md:w-1/3" />
            </div>
            <div class="overflow-x-auto">
                <table class="custom-table">
                     <thead>
                        <tr>
                            <th data-col="vin" class="sortable">VIN</th>
                            <th data-col="stock" class="sortable">Stock</th>
                            <th data-col="make" class="sortable">Make</th>
                            <th data-col="model" class="sortable">Model</th>
                            <th data-col="year" class="sortable">Year</th>
                            <th data-col="date" class="sortable">Date</th>
                            <th data-col="detailed" class="sortable">Detailed</th>
                            <th data-col="photoType" class="sortable">Photos</th>
                            <th data-col="halfReason" class="sortable">Half Reason</th>
                            <th data-col="days" class="sortable text-center">Days</th>
                            <th>Comment</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="completedTable"></tbody>
                </table>
            </div>
             <div class="p-4 flex justify-center items-center space-x-4 bg-slate-50 border-t border-slate-200">
                <button id="completedPrevBtn" class="btn btn-secondary">Previous</button>
                <span id="completedPageInfo" class="text-sm text-gray-600"></span>
                <button id="completedNextBtn" class="btn btn-secondary">Next</button>
            </div>
        </section>

        <section class="card overflow-hidden">
            <div class="p-6">
                <h2 class="text-lg font-semibold">Daily Summary for <span id="reportDate" class="text-blue-600"></span></h2>
            </div>
            <div id="dailySummaryContent">
                <div class="overflow-x-auto">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Stock</th>
                                <th>Make</th>
                                <th>Model</th>
                                <th>Year</th>
                                <th>Detailed</th>
                                <th class="text-center">Description</th>
                                <th class="text-center">Glovebox</th>
                                <th class="text-center">Recaptured</th>
                                <th>Photos</th>
                                <th>Comment</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dailySummaryTable"></tbody>
                    </table>
                </div>
            </div>
            <div id="noDailyEntries" class="p-6 text-center text-gray-500 hidden">No vehicles completed today.</div>
        </section>
    </main>

    <div id="completeModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-40 p-4">
        <div class="modal-card w-full max-w-md p-6">
            <h3 class="text-lg font-semibold mb-4">Complete Vehicle</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Detailed?</label>
                    <select id="completeDetailed" class="form-input mt-1"><option value="">Select…</option><option>Yes</option><option>No</option></select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Photos?</label>
                    <select id="completePhotoType" class="form-input mt-1"><option value="">Select…</option><option>Full Photos</option><option>Half Photos</option></select>
                </div>
                <div id="halfReasonContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700">Reason for half photos</label>
                    <textarea id="completeHalfReason" class="form-input mt-1" rows="2"></textarea>
                </div>
                <hr/>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Photos Need Recapture?</label>
                    <select id="recaptureNeeded" class="form-input mt-1"><option value="">Select…</option><option value="Yes">Yes</option><option value="No">No</option></select>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Recapture Comment</label>
                    <textarea id="recaptureComment" class="form-input mt-1" rows="2"></textarea>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" onclick="closeCompleteModal()" class="btn btn-secondary">Cancel</button>
                <button type="button" onclick="confirmComplete()" class="btn btn-success">Submit</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-40 p-4">
        <div class="modal-card w-full max-w-lg p-6">
             <h3 class="text-lg font-semibold mb-4">Edit Vehicle Entry</h3>
             <input type="hidden" id="editId" /><input type="hidden" id="editCollection" />
             <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                <input id="editVin" placeholder="VIN" class="form-input" />
                <input id="editStock" placeholder="Stock" class="form-input" />
                <input id="editMake" placeholder="Make" class="form-input" />
                <input id="editModel" placeholder="Model" class="form-input" />
                <select id="editYear" class="form-input"><option value="">Year</option></select>
                <input id="editDate" type="date" class="form-input" />
                <select id="editDetailed" class="form-input"><option value="">Detailed?</option><option>Yes</option><option>No</option></select>
                <select id="editPhotoType" class="form-input"><option value="">Photos?</option><option>Full Photos</option><option>Half Photos</option></select>
             </div>
             <textarea id="editComment" rows="3" placeholder="Comment" class="form-input w-full"></textarea>
             <div class="mt-6 flex justify-end space-x-3">
                <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                <button type="button" id="saveEditBtn" class="btn btn-primary">Save Changes</button>
             </div>
        </div>
    </div>

<script>
    // ==========================
    // FIREBASE CONFIGURATION
    // ==========================
    const firebaseConfig = {
        apiKey: "AIzaSyC-hy3eteka35c3ZkLl7exTQ0nnFz9xhFU",
        authDomain: "thh-merch-report.firebaseapp.com",
        projectId: "thh-merch-report",
        storageBucket: "thh-merch-report.appspot.com",
        messagingSenderId: "214148544505",
        appId: "1:214148544505:web:ef4889d43b8189f5146f28"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ==========================
    // STATE & CONSTANTS
    // ==========================
    let pendingData = [], completedData = [], filteredCompletedData = [];
    let currentPendingPage = 0, currentCompletedPage = 0;
    const PAGE_SIZE = 15;
    const sortState = {
        pending: { col: 'date', dir: 'desc' },
        completed: { col: 'date', dir: 'desc' }
    };
    let currentEdit = { id: null, collection: '' };

    // ==========================
    // UI & UTILITY FUNCTIONS
    // ==========================
    const showSpinner = () => document.getElementById('spinnerOverlay').classList.remove('hidden');
    const hideSpinner = () => document.getElementById('spinnerOverlay').classList.add('hidden');
    const closeModal = () => document.getElementById('editModal').classList.add('hidden');
    const closeCompleteModal = () => document.getElementById('completeModal').classList.add('hidden');
    const showToast = msg => {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.remove('hidden');
        setTimeout(() => t.classList.add('hidden'), 3000);
    };
    const getTodayDate = () => new Date().toISOString().split('T')[0];
    const getDisplayDate = dateStr => new Date(dateStr + 'T00:00:00').toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
    const calculateDays = dateStr => Math.floor((new Date() - new Date(dateStr + 'T00:00:00')) / 86400000);

    // ==========================
    // RENDERING LOGIC
    // ==========================
    function applySort(tableKey, dataArray) {
        const { col, dir } = sortState[tableKey];
        return [...dataArray].sort((a, b) => {
            const valA = col === 'days' ? calculateDays(a.data.date) : (a.data[col] || '');
            const valB = col === 'days' ? calculateDays(b.data.date) : (b.data[col] || '');
            const comparison = String(valA).localeCompare(String(valB), undefined, { numeric: true });
            return dir === 'asc' ? comparison : -comparison;
        });
    }

    function renderTable(key, tbodyId, data, page, size, rowFunc, emptyMsg) {
        const tbody = document.getElementById(tbodyId);
        const sorted = applySort(key, data);
        const totalItems = sorted.length, totalPages = Math.ceil(totalItems / size) || 1;
        page = Math.max(0, Math.min(page, totalPages - 1));
        if (key === 'pending') currentPendingPage = page; else currentCompletedPage = page;
        
        const pageSlice = sorted.slice(page * size, (page * size) + size);
        tbody.innerHTML = pageSlice.length ? pageSlice.map(rowFunc).join('') : `<tr><td colspan="12" class="text-center py-10 text-gray-500">${emptyMsg}</td></tr>`;
        
        document.getElementById(`${key}PageInfo`).textContent = `Page ${page + 1} of ${totalPages}`;
        document.getElementById(`${key}PrevBtn`).disabled = page === 0;
        document.getElementById(`${key}NextBtn`).disabled = page >= totalPages - 1;
    }

    const createPendingRow = doc => {
        const d = doc.data, days = calculateDays(d.date);
        const badgeStyle = days > 3 ? 'text-red-700 bg-red-100' : 'text-gray-700 bg-gray-100';
        return `<tr>
            <td>${d.vin || ''}</td><td class="font-semibold text-gray-900">${d.stock}</td><td>${d.make}</td><td>${d.model}</td>
            <td>${d.year}</td><td>${d.date}</td><td class="text-center"><span class="px-2 py-0.5 text-xs rounded-full font-medium ${badgeStyle}">${days}</span></td>
            <td class="text-gray-500 truncate" style="max-width: 200px;">${d.comment || ''}</td>
            <td><div class="flex items-center justify-center space-x-2">
                <button onclick="openCompleteModal('${doc.id}')" class="btn btn-success">Complete</button>
                <button onclick="openEditModal('${doc.id}', 'pending_vehicles')" class="btn btn-warning">Edit</button>
                <button onclick="deleteEntry('${doc.id}', 'pending_vehicles')" class="btn btn-danger">Delete</button>
            </div></td></tr>`;
    };
    
    const createCompletedRow = doc => {
        const d = doc.data;
        const stockClass = (d.photoType === 'Half Photos' && calculateDays(d.date) > 7) ? (calculateDays(d.date) > 14 ? 'bg-red-100' : 'bg-amber-100') : '';
        return `<tr class="${d.isSold ? 'opacity-50' : ''}">
            <td>${d.vin || ''}</td><td class="font-semibold text-gray-900 ${stockClass}">${d.stock}</td><td>${d.make}</td><td>${d.model}</td><td>${d.year}</td><td>${d.date}</td>
            <td>${d.detailed || ''}</td><td>${d.photoType || ''}</td>
            <td class="text-gray-500 truncate" style="max-width: 150px;">${d.halfReason || ''}</td>
            <td class="text-center">${calculateDays(d.originalEntryDate || d.date)}</td>
            <td class="text-gray-500 truncate" style="max-width: 150px;">${d.comment || ''}</td>
            <td><div class="flex items-center justify-center space-x-2">
                <button onclick="openEditModal('${doc.id}', 'vehicles')" class="btn btn-warning">Edit</button>
                <button onclick="deleteEntry('${doc.id}', 'vehicles')" class="btn btn-danger">Delete</button>
            </div></td></tr>`;
    };

    function renderDailySummary() {
        const today = getTodayDate();
        document.getElementById('reportDate').textContent = getDisplayDate(today);
        const dailyEntries = completedData.filter(doc => doc.data.date === today);
        document.getElementById('dailySummaryContent').classList.toggle('hidden', dailyEntries.length === 0);
        document.getElementById('noDailyEntries').classList.toggle('hidden', dailyEntries.length > 0);
        const tbody = document.getElementById('dailySummaryTable');
        tbody.innerHTML = dailyEntries.map(doc => {
            const d = doc.data;
            const toggleButton = (field, value) => `<button onclick="toggleSummaryStatus('${doc.id}', '${field}', ${!!value})" class="btn ${value ? 'btn-success' : 'btn-secondary'}">${value ? 'Yes' : 'No'}</button>`;
            return `<tr>
                <td class="font-semibold text-gray-900">${d.stock}</td>
                <td>${d.make}</td>
                <td>${d.model}</td>
                <td>${d.year}</td>
                <td>${d.detailed}</td>
                <td class="text-center">${toggleButton('descriptionUploaded', d.descriptionUploaded)}</td>
                <td class="text-center">${toggleButton('gloveboxDocuments', d.gloveboxDocuments)}</td>
                <td class="text-center">${toggleButton('recaptured', d.recaptured)}</td>
                <td>${d.photoType}</td>
                <td class="text-gray-500 truncate" style="max-width: 150px;">${d.comment || ''}</td>
                <td class="text-center"><button onclick="openEditModal('${doc.id}', 'vehicles')" class="btn btn-warning">Edit</button></td>
            </tr>`;
        }).join('');
    }

    // ==========================
    // ACTIONS
    // ==========================
    async function addPending() {
        const formData = {
            vin: document.getElementById('vin').value.trim().toUpperCase(),
            stock: document.getElementById('stock').value.trim().toUpperCase(),
            make: document.getElementById('make').value.trim(),
            model: document.getElementById('model').value.trim(),
            year: document.getElementById('year').value,
            date: document.getElementById('date').value,
            comment: document.getElementById('comment').value.trim()
        };
        if (!formData.stock || !formData.make || !formData.model || !formData.year || !formData.date) return showToast('Please fill all required fields.');
        if (pendingData.some(item => item.data.stock === formData.stock)) return showToast('Duplicate Stock number in Pending list.');
        
        showSpinner();
        try {
            await db.collection('pending_vehicles').add(formData);
            showToast('Vehicle added successfully!');
            document.querySelector('form').reset();
            document.getElementById('date').value = getTodayDate();
        } catch (e) { console.error(e); showToast('Error adding entry.'); } finally { hideSpinner(); }
    }
    
    async function confirmComplete() {
        const completeData = {
            detailed: document.getElementById('completeDetailed').value,
            photoType: document.getElementById('completePhotoType').value,
            halfReason: document.getElementById('completeHalfReason').value,
            recaptureNeeded: document.getElementById('recaptureNeeded').value,
            recaptureComment: document.getElementById('recaptureComment').value.trim()
        };
        if (!completeData.detailed || !completeData.photoType || !completeData.recaptureNeeded) return showToast('Please fill out all fields.');
        if (completeData.photoType === 'Half Photos' && !completeData.halfReason.trim()) return showToast('Reason for half photos is required.');

        showSpinner();
        try {
            const docRef = db.collection('pending_vehicles').doc(currentEdit.id);
            const doc = await docRef.get();
            if (doc.exists) {
                await db.collection('vehicles').add({
                    ...doc.data(), ...completeData, originalEntryDate: doc.data().date, date: getTodayDate(),
                    completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    recaptured: false, descriptionUploaded: false, gloveboxDocuments: false
                });
                await docRef.delete();
                showToast('Vehicle marked as complete!');
                closeCompleteModal();
            }
        } catch (e) { console.error(e); showToast('Error completing vehicle.'); } finally { hideSpinner(); }
    }

    function openCompleteModal(id) {
        currentEdit.id = id;
        // Reset fields
        document.getElementById('completeDetailed').value = '';
        document.getElementById('completePhotoType').value = '';
        document.getElementById('completeHalfReason').value = '';
        document.getElementById('recaptureNeeded').value = '';
        document.getElementById('recaptureComment').value = '';
        document.getElementById('halfReasonContainer').classList.add('hidden');
        // Show modal
        document.getElementById('completeModal').classList.remove('hidden');
    }
    
    function openEditModal(id, collection) {
        currentEdit = { id, collection };
        showSpinner();
        db.collection(collection).doc(id).get().then(doc => {
            if(doc.exists) {
                const d = doc.data();
                Object.keys(d).forEach(key => {
                    const el = document.getElementById(`edit${key.charAt(0).toUpperCase() + key.slice(1)}`);
                    if(el) el.value = d[key];
                });
                document.getElementById('editModal').classList.remove('hidden');
            }
        }).catch(e => { console.error(e); showToast('Error fetching document.'); }).finally(hideSpinner);
    }
    
    async function deleteEntry(id, collection) {
        if (!confirm('Are you sure you want to permanently delete this entry?')) return;
        showSpinner();
        try {
            await db.collection(collection).doc(id).delete();
            showToast('Entry deleted!');
        } catch(e) { console.error(e); showToast('Error deleting entry.'); } finally { hideSpinner(); }
    }

    async function toggleSummaryStatus(id, field, currentValue) {
        showSpinner();
        try {
            await db.collection('vehicles').doc(id).update({ [field]: !currentValue });
            showToast('Status updated.');
        } catch (e) { console.error(e); showToast('Error updating status.'); } finally { hideSpinner(); }
    }

    // ==========================
    // INITIALIZATION & LISTENERS
    // ==========================
    document.addEventListener('DOMContentLoaded', () => {
        // Populate year dropdowns
        const currentYear = new Date().getFullYear();
        document.querySelectorAll('#year, #editYear').forEach(sel => {
            for (let y = currentYear + 1; y >= 2000; y--) sel.append(new Option(y, y));
        });
        document.getElementById('date').value = getTodayDate();
        setupSorting();

        // Firebase Listeners
        db.collection('pending_vehicles').onSnapshot(snapshot => {
            pendingData = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
            renderTable('pending', 'pendingTable', pendingData, currentPendingPage, PAGE_SIZE, createPendingRow, 'No pending vehicles.');
        }, err => { console.error(err); showToast('Error loading pending vehicles.'); });

        db.collection('vehicles').onSnapshot(snapshot => {
            completedData = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
            document.getElementById('searchCompleted').dispatchEvent(new Event('input'));
            renderDailySummary();
        }, err => { console.error(err); showToast('Error loading completed vehicles.'); });
        
        // Event Listeners
        document.getElementById('searchCompleted').addEventListener('input', e => {
            const term = e.target.value.toLowerCase();
            filteredCompletedData = completedData.filter(item => Object.values(item.data).some(val => String(val).toLowerCase().includes(term)));
            renderTable('completed', 'completedTable', filteredCompletedData, 0, PAGE_SIZE, createCompletedRow, 'No results found.');
        });
        
        document.getElementById('saveEditBtn').addEventListener('click', async () => {
            const data = {
                vin: document.getElementById('editVin').value, stock: document.getElementById('editStock').value,
                make: document.getElementById('editMake').value, model: document.getElementById('editModel').value,
                year: document.getElementById('editYear').value, date: document.getElementById('editDate').value,
                detailed: document.getElementById('editDetailed').value, photoType: document.getElementById('editPhotoType').value,
                comment: document.getElementById('editComment').value, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            showSpinner();
            try {
                await db.collection(currentEdit.collection).doc(currentEdit.id).update(data);
                showToast('Changes saved!');
                closeModal();
            } catch (e) { console.error(e); showToast('Error saving changes.'); } finally { hideSpinner(); }
        });
        
        document.getElementById('completePhotoType').addEventListener('change', e => {
            document.getElementById('halfReasonContainer').classList.toggle('hidden', e.target.value !== 'Half Photos');
        });

        document.getElementById('pendingPrevBtn').onclick = () => renderTable('pending', 'pendingTable', pendingData, currentPendingPage - 1, PAGE_SIZE, createPendingRow, 'No pending vehicles.');
        document.getElementById('pendingNextBtn').onclick = () => renderTable('pending', 'pendingTable', pendingData, currentPendingPage + 1, PAGE_SIZE, createPendingRow, 'No pending vehicles.');
        document.getElementById('completedPrevBtn').onclick = () => renderTable('completed', 'completedTable', filteredCompletedData, currentCompletedPage - 1, PAGE_SIZE, createCompletedRow, 'No completed vehicles.');
        document.getElementById('completedNextBtn').onclick = () => renderTable('completed', 'completedTable', filteredCompletedData, currentCompletedPage + 1, PAGE_SIZE, createCompletedRow, 'No completed vehicles.');
    });

    function setupSorting() {
        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.col;
                const tableKey = th.closest('table').querySelector('tbody').id.includes('pending') ? 'pending' : 'completed';
                
                if (sortState[tableKey].col === column) {
                    sortState[tableKey].dir = sortState[tableKey].dir === 'asc' ? 'desc' : 'asc';
                } else {
                    sortState[tableKey].col = column;
                    sortState[tableKey].dir = 'asc';
                }

                document.querySelectorAll(`th.sortable`).forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
                th.classList.add(sortState[tableKey].dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
                
                if (tableKey === 'pending') {
                    renderTable('pending', 'pendingTable', pendingData, currentPendingPage, PAGE_SIZE, createPendingRow, 'No pending vehicles.');
                } else {
                    renderTable('completed', 'completedTable', filteredCompletedData, currentCompletedPage, PAGE_SIZE, createCompletedRow, 'No completed vehicles.');
                }
            });
        });
    }
</script>
</body>
</html>