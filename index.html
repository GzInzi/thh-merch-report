<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>THH Merchandising Report</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    /* Custom CSS for a more colorful theme and animations */
    :root {
      --primary-color: #6366f1; /* Indigo 500 - for main buttons, focus rings */
      --secondary-color: #8b5cf6; /* Violet 500 - for secondary actions, accents */
      --accent-color: #ec4899; /* Pink 500 - for highlights, active states */
      --background-light: #f3f4f6; /* Gray 100 - for main body background */
      --background-card: #ffffff; /* White - for section backgrounds */
      --text-dark: #1f2937; /* Gray 800 - for main text */
      --text-medium: #4b5563; /* Gray 600 - for labels, secondary text */
      --border-color: #d1d5db; /* Gray 300 - for input borders, table borders */
    }

    html, body {
      width: 100%;
      margin: 0;
      padding: 0;
      scroll-behavior: smooth;
      background-color: var(--background-light); /* Apply to body */
      color: var(--text-dark); /* Apply to body text */
    }
    /* Adjusted table styling for borders */
    table {
        border-collapse: collapse; /* Essential for proper border rendering */
    }
    table th, table td {
      white-space: nowrap;
      border: 1px solid var(--border-color); /* Apply border to all cells */
    }
    th.sortable {
      cursor: pointer;
      transition: background-color 0.3s;
    }
    th.sortable:hover {
      background-color: #f0f0f0;
    }
    th.sorted-asc::after {
      content: " ▲";
      font-size: 0.7em;
      transition: transform 0.3s ease-out;
      transform: translateY(-2px);
    }
    th.sorted-desc::after {
      content: " ▼";
      font-size: 0.7em;
      transition: transform 0.3s ease-out;
      transform: translateY(2px);
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(10px); }
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @keyframes slideInFromLeft {
        from { opacity: 0; transform: translateX(-20px); }
        to { opacity: 1; transform: translateX(0); }
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    /* New CSS for highlighting duplicate rows */
    @keyframes highlightFlash {
        0% { background-color: transparent; }
        50% { background-color: #ffeb3b; } /* Yellow 500 */
        100% { background-color: transparent; }
    }

    .highlight-flash {
        animation: highlightFlash 1.5s ease-out;
    }

    .toast-enter { animation: fadeIn 0.3s forwards; }
    .toast-exit { animation: fadeOut 0.3s forwards; }
    .spinner {
      animation: spin 1s linear infinite;
      border-color: var(--border-color);
      border-top-color: var(--primary-color);
    }
    .modal-enter { animation: fadeIn 0.3s forwards; }
    .modal-exit { animation: fadeOut 0.3s forwards; }
    .section-card-animate {
        transition: all 0.3s ease-in-out;
    }
    .section-card-animate:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    input:focus, select:focus, textarea:focus {
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        border-color: var(--primary-color);
    }
    .table-row-enter {
        animation: slideInFromLeft 0.4s ease-out forwards;
    }
    .button-glow-hover {
        position: relative;
        overflow: hidden;
        z-index: 1;
    }
    .button-glow-hover::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        opacity: 0;
        transform: translate(-50%, -50%);
        transition: width 0.3s ease-out, height 0.3s ease-out, opacity 0.3s ease-out;
        z-index: -1;
    }
    .button-glow-hover:hover::before {
        width: 200%;
        height: 200%;
        opacity: 1;
    }
    .badge-pulse {
        animation: pulse 1.5s infinite ease-in-out;
    }

    /* Override Tailwind */
    .bg-blue-600 { background-color: var(--primary-color); }
    .hover\:bg-blue-700:hover { background-color: #4f46e5; }
    .bg-green-500 { background-color: #22c55e; }
    .hover\:bg-green-600:hover { background-color: #16a34a; }
    .bg-green-600 { background-color: #22c55e; }
    .hover\:bg-green-700:hover { background-color: #16a34a; }
    .bg-yellow-500 { background-color: #f59e0b; }
    .hover\:bg-yellow-600:hover { background-color: #d97706; }
    .bg-red-500 { background-color: #ef4444; }
    .hover\:bg-red-600:hover { background-color: #dc2626; }
    .bg-purple-600 { background-color: var(--secondary-color); }
    .hover\:bg-purple-700:hover { background-color: #7c3aed; }
    #toast { background-color: var(--text-dark); }

    /* START: New Styles for Phone View Simulation */
    #view-wrapper.phone-view {
        max-width: 390px; /* iPhone 12/13/14 width */
        height: 80vh; /* Simulate a viewport height */
        margin: 2rem auto; /* Center the container on the page */
        border: 8px solid var(--text-dark);
        border-radius: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow-y: auto; /* Allow the content inside to scroll */
        transition: all 0.3s ease-in-out;
    }
    /* END: New Styles for Phone View Simulation */

  </style>
</head>

<body class="bg-gray-100 text-gray-800 font-sans">
  <div id="toast" class="fixed bottom-5 right-5 hidden bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg"></div>
  <div id="spinnerOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="border-8 border-gray-200 border-t-8 border-t-blue-600 rounded-full w-16 h-16 spinner"></div>
  </div>

  <div id="view-wrapper">
    <header class="bg-white shadow-md sticky top-0 z-10">
      <div class="container mx-auto px-4 py-6 flex justify-center items-center relative">
        <h1 class="text-3xl font-bold text-center text-gray-800">THH Merchandising Report</h1>
        <button id="viewToggleBtn" onclick="toggleDeviceView()" class="absolute right-4 bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded-lg text-xs sm:text-sm shadow-sm">
          Phone View
        </button>
      </div>
    </header>

    <main class="container mx-auto px-4 py-8 space-y-8">
      <section class="bg-white p-6 rounded-lg shadow-md section-card-animate">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">Data Entry</h2>
        <form class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
          <input id="vin" placeholder="VIN Number (Optional)"
                 class="border p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300" />
          <input id="stock" placeholder="Stock Number"
                 class="border p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300" />
          <span id="stockError" class="text-red-500 text-sm mt-1 hidden col-span-full"></span> <input id="make" placeholder="Make"
                 class="border p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300" />
          <input id="model" placeholder="Model"
                 class="border p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300" />
          <select id="year" class="border p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300">
            <option value="">Year</option>
          </select>
          <input id="date" type="date"
                 class="border p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300" />
          <input id="comment" placeholder="Comment (Optional)"
                 class="border p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300" />
          <div class="sm:col-span-2 md:col-span-4 text-right mt-4">
            <button type="button" onclick="addPending()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow-md transform hover:scale-105 transition-transform duration-300 button-glow-hover">
              Add to Pending
            </button>
          </div>
        </form>
      </section>

      <section class="bg-white p-6 rounded-lg shadow-md section-card-animate">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">Pending Vehicles</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white table-auto text-sm border border-gray-300">
            <thead class="bg-gray-200">
              <tr class="text-left text-gray-600 uppercase text-sm">
                <th data-col="vin" class="px-4 py-2 sortable">VIN</th>
                <th data-col="stock" class="px-4 py-2 sortable">Stock</th>
                <th data-col="make" class="px-4 py-2 sortable">Make</th>
                <th data-col="model" class="px-4 py-2 sortable">Model</th>
                <th data-col="year" class="px-4 py-2 sortable">Year</th>
                <th data-col="date" class="px-4 py-2 sortable">Date</th>
                <th data-col="days" class="px-4 py-2 sortable text-center">Days</th>
                <th class="px-4 py-2">Comment</th>
                <th class="px-4 py-2 text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="pendingTable"></tbody>
          </table>
        </div>
        <div class="mt-4 flex justify-center space-x-2">
          <button id="pendingPrevBtn" onclick="changePendingPage(-1)"
                  class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg disabled:opacity-50 transition-colors duration-300 button-glow-hover">
            Previous
          </button>
          <span id="pendingPageInfo" class="text-sm text-gray-700 self-center"></span>
          <button id="pendingNextBtn" onclick="changePendingPage(1)"
                  class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg disabled:opacity-50 transition-colors duration-300 button-glow-hover">
            Next
          </button>
        </div>
      </section>

      <section class="bg-white p-6 rounded-lg shadow-md section-card-animate">
        <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4">
          <h2 class="text-2xl font-semibold text-gray-700">Completed Vehicles</h2>
          <input id="searchCompleted" type="text" placeholder="Search VIN, Stock, Make…"
                 class="border p-3 rounded-lg w-full md:w-1/3 mt-2 md:mt-0 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300" />
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white table-auto text-sm border border-gray-300">
            <thead class="bg-gray-200">
              <tr class="text-left text-gray-600 uppercase text-sm">
                <th data-col="vin" class="px-4 py-2 sortable">VIN</th>
                <th data-col="stock" class="px-4 py-2 sortable">Stock</th>
                <th data-col="make" class="px-4 py-2 sortable">Make</th>
                <th data-col="model" class="px-4 py-2 sortable">Model</th>
                <th data-col="year" class="px-4 py-2 sortable">Year</th>
                <th data-col="date" class="px-4 py-2 sortable">Date</th>
                <th data-col="detailed" class="px-4 py-2 sortable">Detailed</th>
                <th data-col="photoType" class="px-4 py-2 sortable">Photos</th>
                <th data-col="halfReason" class="px-4 py-2 sortable">Half Reason</th>
                <th data-col="days" class="px-4 py-2 sortable text-center">Days</th>
                <th class="px-4 py-2">Comment</th>
                <th class="px-4 py-2 text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="completedTable"></tbody>
          </table>
        </div>
        <div class="mt-4 flex justify-center space-x-2">
          <button id="completedPrevBtn" onclick="changeCompletedPage(-1)"
                  class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg disabled:opacity-50 transition-colors duration-300 button-glow-hover">
            Previous
          </button>
          <span id="completedPageInfo" class="text-sm text-gray-700 self-center"></span>
          <button id="completedNextBtn" onclick="changeCompletedPage(1)"
                  class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg disabled:opacity-50 transition-colors duration-300 button-glow-hover">
            Next
          </button>
        </div>
      </section>

      <section class="bg-white p-6 rounded-lg shadow-md section-card-animate">
        <h2 class="text-2xl font-semibold mb-4 text-gray-700">Daily Summary Report for <span id="reportDate" class="text-primary-color"></span></h2>
        <div class="overflow-x-auto">
          <table class="min-w-full bg-white table-auto text-sm border border-gray-300">
            <thead class="bg-gray-200">
              <tr class="text-left text-gray-600 uppercase text-sm">
                <th class="px-4 py-2">Stock</th>
                <th class="px-4 py-2">Make</th>
                <th class="px-4 py-2">Model</th>
                <th class="px-4 py-2">Year</th>
                <th class="px-4 py-2">Detailed</th>
                <th class="px-4 py-2 text-center">Description</th>
                <th class="px-4 py-2 text-center">Glovebox</th>
                <th class="px-4 py-2 text-center">Recaptured</th>
                <th class="px-4 py-2">Photos</th>
                <th class="px-4 py-2">Comment</th>
                <th class="px-4 py-2 text-center">Actions</th>
              </tr>
            </thead>
            <tbody id="dailySummaryTable">
              </tbody>
          </table>
        </div>
        <div id="noDailyEntries" class="p-4 text-center text-gray-500 hidden">No completed tasks for today. Keep up the great work!</div>
      </section>
    </main>
  </div>
  <div id="completeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-40">
    <div class="bg-white p-6 rounded-lg w-11/12 max-w-md shadow-2xl modal-enter">
      <button onclick="closeCompleteModal()"
              class="close-button float-right text-gray-500 hover:text-gray-800 text-2xl transform hover:rotate-90 transition-transform duration-300">&times;</button>
      <h3 class="text-xl font-semibold mb-4 text-gray-700">Complete Vehicle</h3>
      <div class="mb-4">
        <label class="block mb-2 text-sm font-medium text-gray-600">Detailed?</label>
        <select id="completeDetailed" class="border p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300">
          <option value="">Select…</option><option>Yes</option><option>No</option>
        </select>
      </div>
      <div class="mb-4">
        <label class="block mb-2 text-sm font-medium text-gray-600">Photos?</label>
        <select id="completePhotoType" class="border p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300">
          <option value="">Select…</option><option>Full Photos</option><option>Half Photos</option>
        </select>
      </div>
      <div id="halfReasonContainer" class="mb-4 hidden">
        <label class="block mb-2 text-sm font-medium text-gray-600">Reason for half photographs</label>
        <textarea id="completeHalfReason" class="border p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300"
                  rows="3"></textarea>
      </div>
      <div class="text-right mt-6">
        <button onclick="confirmComplete()"
                class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg shadow-md transform hover:scale-105 transition-transform duration-300 button-glow-hover">
          Submit
        </button>
      </div>
    </div>
  </div>

  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-40">
    <div class="bg-white p-6 rounded-lg w-11/12 max-w-lg shadow-2xl modal-enter">
      <button onclick="closeModal()" class="close-button float-right text-gray-500 hover:text-gray-800 text-2xl transform hover:rotate-90 transition-transform duration-300">&times;</button>
      <h3 class="text-xl font-semibold mb-4 text-gray-700">Edit Vehicle Entry</h3>
      <input type="hidden" id="editId" />
      <input type="hidden" id="editCollection" />
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-4">
        <input id="editVin" placeholder="VIN" class="border p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300" />
        <input id="editStock" placeholder="Stock" class="border p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300" />
        <input id="editMake" placeholder="Make" class="border p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300" />
        <input id="editModel" placeholder="Model" class="border p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300" />
        <select id="editYear" class="border p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300">
          <option value="">Year</option>
        </select>
        <input id="editDate" type="date" class="border p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300" />
        <select id="editDetailed" class="border p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300">
          <option value="">Detailed?</option><option>Yes</option><option>No</option>
        </select>
        <select id="editPhotoType" class="border p-3 rounded-lg w-full focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300">
          <option value="">Photos?</option><option>Full Photos</option><option>Half Photos</option>
        </select>
      </div>
      <textarea id="editComment" rows="3" placeholder="Comment"
                class="border p-3 rounded-lg w-full mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow duration-300"></textarea>
      <div class="text-right">
        <button id="saveEditBtn"
                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow-md transform hover:scale-105 transition-transform duration-300 button-glow-hover">
          Save Changes
        </button>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // FIREBASE CONFIGURATION
    // ==========================
    const firebaseConfig = {
      apiKey: "AIzaSyC-hy3eteka35c3ZkLl7exTQ0nnFz9xhFU",
      authDomain: "thh-merch-report.firebaseapp.com",
      projectId: "thh-merch-report",
      storageBucket: "thh-merch-report.appspot.com",
      messagingSenderId: "214148544505",
      appId: "1:214148544505:web:ef4889d43b8189f5146f28"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ==========================
    // UTILITIES
    // ==========================
    function showSpinner() {
      document.getElementById('spinnerOverlay').classList.remove('hidden');
    }
    function hideSpinner() {
      document.getElementById('spinnerOverlay').classList.add('hidden');
    }
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.remove('hidden', 'toast-exit');
      t.classList.add('toast-enter');
      setTimeout(() => {
        t.classList.remove('toast-enter');
        t.classList.add('toast-exit');
        setTimeout(() => t.classList.add('hidden'), 300);
      }, 3000);
    }

    function getTodayDate() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function getDisplayDate(dateString) {
      const options = { year: 'numeric', month: 'long', day: 'numeric' };
      return new Date(dateString).toLocaleDateString(undefined, options);
    }

    document.querySelectorAll('#year,#editYear').forEach(sel => {
      const currentYear = new Date().getFullYear();
      for (let y = currentYear; y >= 2000; y--) {
        sel.append(new Option(y, y));
      }
    });
    
    document.getElementById('date').value = getTodayDate();

    // ==========================
    // START: New View Toggle Function
    // ==========================
    function toggleDeviceView() {
        const wrapper = document.getElementById('view-wrapper');
        const button = document.getElementById('viewToggleBtn');
        wrapper.classList.toggle('phone-view');

        // Update button text to reflect the current state
        if (wrapper.classList.contains('phone-view')) {
            button.textContent = 'Desktop View';
        } else {
            button.textContent = 'Phone View';
        }
    }
    // END: New View Toggle Function

    // ==========================
    // DATA ARRAYS & SORT / PAGINATION STATE
    // ==========================
    let pendingData = [];
    let completedData = [];
    let filteredCompletedData = [];
    let currentPendingPage = 0;
    let currentCompletedPage = 0;
    const pendingPageSize = 15;
    const completedPageSize = 15;
    const sortState = {
      pending: { col: null, dir: 'desc' },
      completed: { col: null, dir: 'desc' }
    };

    // ==========================
    // ADD PENDING ENTRY
    // ==========================
    async function addPending() {
        document.getElementById('stock').classList.remove('border-red-500');
        document.getElementById('stockError').classList.add('hidden');
        document.getElementById('stockError').textContent = '';

        const vin = document.getElementById('vin').value.trim().toUpperCase();
        const stock = document.getElementById('stock').value.trim().toUpperCase();
        const make = document.getElementById('make').value.trim();
        const model = document.getElementById('model').value.trim();
        const year = document.getElementById('year').value;
        let date = document.getElementById('date').value;
        const comment = document.getElementById('comment').value.trim();

        if (!stock || !make || !model || !year || !date) {
            showToast('Please fill in Stock, Make, Model, Year & Date.');
            return;
        }

        const duplicateInPending = pendingData.find(item => item.data.stock.toUpperCase() === stock);
        if (duplicateInPending) {
            document.getElementById('stock').classList.add('border-red-500');
            document.getElementById('stockError').textContent = 'Duplicate Stock number already in Pending list!';
            document.getElementById('stockError').classList.remove('hidden');

            const tbody = document.getElementById('pendingTable');
            const duplicateRow = tbody.querySelector(`tr[data-id="${duplicateInPending.id}"]`);
            if (duplicateRow) {
                duplicateRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                duplicateRow.classList.add('highlight-flash');
                setTimeout(() => duplicateRow.classList.remove('highlight-flash'), 1500);
            }
            showToast('Stock number already exists in Pending list.');
            return;
        }

        const existingInCompleted = completedData.find(item => item.data.stock.toUpperCase() === stock);
        if (existingInCompleted) {
            date = existingInCompleted.data.originalEntryDate || existingInCompleted.data.date;
            showToast(`Stock ${stock} re-added. Preserving original date: ${date}`);
        } else {
            date = document.getElementById('date').value;
        }

        showSpinner();
        try {
            await db.collection('pending_vehicles').add({ vin, stock, make, model, year, date, comment });
            showToast('Vehicle added to pending successfully!');
            document.getElementById('vin').value = '';
            document.getElementById('stock').value = '';
            document.getElementById('make').value = '';
            document.getElementById('model').value = '';
            document.getElementById('date').value = getTodayDate();
            document.getElementById('comment').value = '';
        } catch (e) {
            console.error("CRITICAL Firebase Add Error on submission:", e);
            showToast('FATAL ERROR: Could not add entry. Check console for details.');
        } finally {
            hideSpinner();
        }
    }

    // ==========================
    // SORT FUNCTIONALITY
    // ==========================
    function applySort(table, dataArray) {
      const { col, dir } = sortState[table];
      const src = [...dataArray]; 
      if (!col) {
        return src.sort((a, b) => new Date(b.data.date) - new Date(a.data.date));
      }
      return src.sort((a, b) => {
        let va, vb;
        if (col === 'days') {
          va = Math.floor((new Date() - new Date(a.data.date)) / (1000 * 60 * 60 * 24));
          vb = Math.floor((new Date() - new Date(b.data.date)) / (1000 * 60 * 60 * 24));
        } else {
          va = a.data[col] || '';
          vb = b.data[col] || '';
        }
        let res = 0;
        if (col === 'year' || col === 'days') {
          res = (parseFloat(va) || 0) - (parseFloat(vb) || 0);
        } else if (col === 'date') {
          res = new Date(va) - new Date(vb);
        } else {
          res = String(va).localeCompare(String(vb), undefined, { numeric: true, sensitivity: 'base' });
        }
        return dir === 'asc' ? res : -res;
      });
    }

    function setupSorting() {
      document.querySelectorAll('th.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const column = th.dataset.col;
          const parentTable = th.closest('table');
          const tblKey = parentTable.querySelector('tbody').id === 'pendingTable' ? 'pending' : 'completed';
          const state = sortState[tblKey];
          parentTable.querySelectorAll('th.sortable').forEach(x => x.classList.remove('sorted-asc','sorted-desc'));
          if (state.col === column) {
            state.dir = state.dir === 'asc' ? 'desc' : 'asc';
          } else {
            state.col = column;
            state.dir = 'asc';
          }
          th.classList.add(state.dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
          if (tblKey === 'pending') {
            currentPendingPage = 0;
            renderPending();
          }
          else {
            currentCompletedPage = 0;
            renderCompleted();
          }
        });
      });
    }

    // ==========================
    // RENDER PENDING VEHICLES
    // ==========================
    function renderPending() {
      const sorted = applySort('pending', pendingData);
      const totalItems = sorted.length;
      const totalPages = Math.ceil(totalItems / pendingPageSize) || 1;
      if (currentPendingPage >= totalPages) currentPendingPage = totalPages - 1;
      const start = currentPendingPage * pendingPageSize;
      const end = start + pendingPageSize;
      const pageSlice = sorted.slice(start, end);
      const tbody = document.getElementById('pendingTable');
      tbody.innerHTML = '';
      if (pageSlice.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="p-4 text-center text-gray-500 border-0">No pending vehicles</td></tr>`;
      } else {
        pageSlice.forEach((doc, idx) => {
          const d = doc.data;
          const days = Math.floor((new Date() - new Date(d.date)) / (1000 * 60 * 60 * 24));
          const badgeColor = days > 3 ? 'bg-red-500 text-white badge-pulse' : 'bg-blue-100 text-blue-800';
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-50 transition-colors duration-200 table-row-enter';
          tr.dataset.id = doc.id;
          tr.style.animationDelay = `${idx * 0.05}s`;
          tr.innerHTML = `
            <td class="px-4 py-2">${d.vin}</td>
            <td class="px-4 py-2">${d.stock}</td>
            <td class="px-4 py-2">${d.make}</td>
            <td class="px-4 py-2">${d.model}</td>
            <td class="px-4 py-2">${d.year}</td>
            <td class="px-4 py-2">${d.date}</td>
            <td class="px-4 py-2 text-center"><span class="inline-block ${badgeColor} text-xs font-semibold px-2 py-1 rounded-full">${days}</span></td>
            <td class="px-4 py-2">${d.comment || '-'}</td>
            <td class="px-4 py-2 flex space-x-2 justify-center">
              <button onclick="openCompleteModal('${doc.id}')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md text-xs shadow-sm transform hover:scale-105 transition-all duration-200 button-glow-hover">Complete</button>
              <button onclick="openEditModal('${doc.id}','pending_vehicles')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-md text-xs shadow-sm transform hover:scale-105 transition-all duration-200 button-glow-hover">Edit</button>
              <button onclick="deleteEntry('${doc.id}','pending_vehicles')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-xs shadow-sm transform hover:scale-105 transition-all duration-200 button-glow-hover">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }
      document.getElementById('pendingPageInfo').textContent = `Page ${currentPendingPage + 1} of ${totalPages}`;
      document.getElementById('pendingPrevBtn').disabled = (currentPendingPage === 0);
      document.getElementById('pendingNextBtn').disabled = (currentPendingPage >= totalPages - 1);
    }

    function changePendingPage(delta) {
      const newPage = currentPendingPage + delta;
      const totalPages = Math.ceil(pendingData.length / pendingPageSize) || 1;
      if (newPage >= 0 && newPage < totalPages) {
        currentPendingPage = newPage;
        renderPending();
      }
    }

    // ==========================
    // RENDER COMPLETED VEHICLES
    // ==========================
    function renderCompleted() {
      const searchVal = document.getElementById('searchCompleted').value.toLowerCase();
      filteredCompletedData = searchVal ? completedData.filter(item => {
        const d = item.data;
        return (d.vin || '').toLowerCase().includes(searchVal)
             || (d.stock || '').toLowerCase().includes(searchVal)
             || (d.make || '').toLowerCase().includes(searchVal)
             || (d.model || '').toLowerCase().includes(searchVal);
      }) : completedData;
      const sorted = applySort('completed', filteredCompletedData);
      const totalItems = sorted.length;
      const totalPages = Math.ceil(totalItems / completedPageSize) || 1;
      if (currentCompletedPage >= totalPages) currentCompletedPage = totalPages - 1;
      const start = currentCompletedPage * completedPageSize;
      const end = start + completedPageSize;
      const pageSlice = sorted.slice(start, end);
      const tbody = document.getElementById('completedTable');
      tbody.innerHTML = '';
      if (pageSlice.length === 0) {
        tbody.innerHTML = `<tr><td colspan="12" class="p-4 text-center text-gray-500 border-0">${searchVal ? 'No matches found' : 'No completed vehicles'}</td></tr>`;
      } else {
        pageSlice.forEach((doc, idx) => {
          const d = doc.data;
          const days = Math.floor((new Date() - new Date(d.date)) / (1000 * 60 * 60 * 24));
          let stockCellClass = '';
          if (d.photoType === 'Half Photos') {
            if (days > 14) stockCellClass = 'bg-red-200 text-red-800';
            else if (days > 7) stockCellClass = 'bg-yellow-200 text-yellow-800';
          }
          let commentContent = d.comment || '-';
          if (commentContent.startsWith('http://') || commentContent.startsWith('https://')) {
            commentContent = `<a href="${commentContent}" target="_blank" class="text-blue-600 hover:underline">${commentContent}</a>`;
          }
          const tr = document.createElement('tr');
          tr.className = `${d.isSold ? 'opacity-50 line-through' : ''} hover:bg-gray-50 transition-all duration-200 table-row-enter`;
          tr.style.animationDelay = `${idx * 0.05}s`;
          tr.innerHTML = `
            <td class="px-4 py-2">${d.vin}</td>
            <td class="px-4 py-2 ${stockCellClass}">${d.stock}</td>
            <td class="px-4 py-2">${d.make}</td>
            <td class="px-4 py-2">${d.model}</td>
            <td class="px-4 py-2">${d.year}</td>
            <td class="px-4 py-2">${d.date}</td>
            <td class="px-4 py-2">${d.detailed || '-'}</td>
            <td class="px-4 py-2">${d.photoType || '-'}</td>
            <td class="px-4 py-2">${d.halfReason || '-'}</td>
            <td class="px-4 py-2 text-center"><span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full badge-pulse">${days}</span></td>
            <td class="px-4 py-2">${commentContent}</td>
            <td class="px-4 py-2 flex space-x-2 justify-center">
              <button onclick="openEditModal('${doc.id}','vehicles')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-md text-xs shadow-sm transform hover:scale-105 transition-all duration-200 button-glow-hover">Edit</button>
              <button onclick="deleteEntry('${doc.id}','vehicles')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md text-xs shadow-sm transform hover:scale-105 transition-all duration-200 button-glow-hover">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }
      document.getElementById('completedPageInfo').textContent = `Page ${currentCompletedPage + 1} of ${totalPages}`;
      document.getElementById('completedPrevBtn').disabled = (currentCompletedPage === 0);
      document.getElementById('completedNextBtn').disabled = (currentCompletedPage >= totalPages - 1);
    }

    function changeCompletedPage(delta) {
      const newPage = currentCompletedPage + delta;
      const totalPages = Math.ceil(filteredCompletedData.length / completedPageSize) || 1;
      if (newPage >= 0 && newPage < totalPages) {
        currentCompletedPage = newPage;
        renderCompleted();
      }
    }

    // ==========================
    // RENDER DAILY SUMMARY
    // ==========================
    function renderDailySummary() {
      const today = getTodayDate();
      document.getElementById('reportDate').textContent = getDisplayDate(today);
      const dailyEntries = completedData.filter(doc => doc.data.date === today);
      const tbody = document.getElementById('dailySummaryTable');
      tbody.innerHTML = '';
      const noEntriesMessage = document.getElementById('noDailyEntries');
      if (dailyEntries.length === 0) {
        noEntriesMessage.classList.remove('hidden');
      } else {
        noEntriesMessage.classList.add('hidden');
        dailyEntries.forEach((doc, idx) => {
          const d = doc.data;
          let commentContent = d.comment || '-';
          if (commentContent.startsWith('http://') || commentContent.startsWith('https://')) {
            commentContent = `<a href="${commentContent}" target="_blank" class="text-blue-600 hover:underline">${commentContent}</a>`;
          }
          const isRecaptured = d.recaptured === true;
          const recapturedButtonClass = isRecaptured ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-300 hover:bg-gray-400 text-gray-700';
          const recapturedButtonText = isRecaptured ? 'Yes' : 'No';
          const isDescriptionUploaded = d.descriptionUploaded === true;
          const descUploadButtonClass = isDescriptionUploaded ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-300 hover:bg-gray-400 text-gray-700';
          const descUploadButtonText = isDescriptionUploaded ? 'Yes' : 'No';
          const isGloveboxDocuments = d.gloveboxDocuments === true;
          const gloveboxButtonClass = isGloveboxDocuments ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-300 hover:bg-gray-400 text-gray-700';
          const gloveboxButtonText = isGloveboxDocuments ? 'Yes' : 'No';
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-gray-50 transition-colors duration-200 table-row-enter';
          tr.style.animationDelay = `${idx * 0.05}s`;
          tr.innerHTML = `
            <td class="px-4 py-2">${d.stock}</td>
            <td class="px-4 py-2">${d.make}</td>
            <td class="px-4 py-2">${d.model}</td>
            <td class="px-4 py-2">${d.year}</td>
            <td class="px-4 py-2">${d.detailed || '-'}</td>
            <td class="px-4 py-2 text-center"> <button onclick="toggleDailySummaryStatus('${doc.id}', 'descriptionUploaded', ${isDescriptionUploaded})" class="px-3 py-1 rounded-md text-xs shadow-sm transform hover:scale-105 transition-all duration-200 button-glow-hover ${descUploadButtonClass} text-white">${descUploadButtonText}</button></td>
            <td class="px-4 py-2 text-center"> <button onclick="toggleDailySummaryStatus('${doc.id}', 'gloveboxDocuments', ${isGloveboxDocuments})" class="px-3 py-1 rounded-md text-xs shadow-sm transform hover:scale-105 transition-all duration-200 button-glow-hover ${gloveboxButtonClass} text-white">${gloveboxButtonText}</button></td>
            <td class="px-4 py-2 text-center"> <button onclick="toggleDailySummaryStatus('${doc.id}', 'recaptured', ${isRecaptured})" class="px-3 py-1 rounded-md text-xs shadow-sm transform hover:scale-105 transition-all duration-200 button-glow-hover ${recapturedButtonClass} text-white">${recapturedButtonText}</button></td>
            <td class="px-4 py-2">${d.photoType || '-'}</td>
            <td class="px-4 py-2">${commentContent}</td>
            <td class="px-4 py-2 flex space-x-2 justify-center"><button onclick="openEditModal('${doc.id}','vehicles')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-md text-xs shadow-sm transform hover:scale-105 transition-all duration-200 button-glow-hover">Edit</button></td>
          `;
          tbody.appendChild(tr);
        });
      }
    }

    // ==========================
    // DAILY SUMMARY STATUS TOGGLE
    // ==========================
    async function toggleDailySummaryStatus(id, fieldName, currentStatus) {
      showSpinner();
      try {
        const newStatus = !currentStatus;
        const updateData = {};
        updateData[fieldName] = newStatus;
        updateData.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
        await db.collection('vehicles').doc(id).update(updateData);
        let displayFieldName = fieldName;
        if (fieldName === 'descriptionUploaded') displayFieldName = 'Description';
        else if (fieldName === 'gloveboxDocuments') displayFieldName = 'Glovebox';
        else displayFieldName = fieldName.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        showToast(`${displayFieldName} status updated to: ${newStatus ? 'Yes' : 'No'}`);
      } catch (e) {
        console.error(`Error updating ${fieldName} status:`, e);
        showToast(`Error updating ${fieldName} status.`);
      } finally {
        hideSpinner();
      }
    }

    // ==========================
    // MODAL FUNCTIONS
    // ==========================
    let currentPendingId = null;

    function openCompleteModal(id) {
      currentPendingId = id;
      document.getElementById('completeDetailed').value = '';
      document.getElementById('completePhotoType').value = '';
      document.getElementById('completeHalfReason').value = '';
      document.getElementById('halfReasonContainer').classList.add('hidden');
      document.getElementById('completeModal').classList.remove('hidden');
    }

    function closeCompleteModal() {
      document.getElementById('completeModal').classList.add('hidden');
    }

    document.getElementById('completePhotoType').addEventListener('change', function() {
      if (this.value === 'Half Photos') {
        document.getElementById('halfReasonContainer').classList.remove('hidden');
      } else {
        document.getElementById('halfReasonContainer').classList.add('hidden');
        document.getElementById('completeHalfReason').value = '';
      }
    });

    async function confirmComplete() {
        const detailed = document.getElementById('completeDetailed').value;
        const photoType = document.getElementById('completePhotoType').value;
        const halfReason = document.getElementById('completeHalfReason').value;
        if (!detailed || !photoType) {
            showToast('Please select Detailed? and Photos? options.');
            return;
        }
        if (photoType === 'Half Photos' && !halfReason.trim()) {
            showToast('Please provide a reason for half photographs.');
            return;
        }
        showSpinner();
        try {
            const pendingDocRef = db.collection('pending_vehicles').doc(currentPendingId);
            const pendingDoc = await pendingDocRef.get();
            if (pendingDoc.exists) {
                const data = pendingDoc.data();
                const completionDate = getTodayDate();
                await db.collection('vehicles').add({
                    ...data,
                    detailed: detailed,
                    photoType: photoType,
                    halfReason: halfReason,
                    originalEntryDate: data.date,
                    date: completionDate,
                    recaptured: false,
                    descriptionUploaded: false,
                    gloveboxDocuments: false,
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                await pendingDocRef.delete();
                closeCompleteModal();
                showToast('Vehicle marked as complete!');
            } else {
                showToast('Pending vehicle not found.');
            }
        } catch (e) {
            console.error(e);
            showToast('Error completing vehicle.');
        } finally {
            hideSpinner();
        }
    }

    let currentEditDocRef = null;

    function openEditModal(id, collectionName) {
      currentEditDocRef = db.collection(collectionName).doc(id);
      document.getElementById('editId').value = id;
      document.getElementById('editCollection').value = collectionName;
      showSpinner();
      currentEditDocRef.get().then(doc => {
        if (doc.exists) {
          const d = doc.data();
          document.getElementById('editVin').value = d.vin || '';
          document.getElementById('editStock').value = d.stock || '';
          document.getElementById('editMake').value = d.make || '';
          document.getElementById('editModel').value = d.model || '';
          document.getElementById('editYear').value = d.year || '';
          document.getElementById('editDate').value = d.date || getTodayDate();
          document.getElementById('editDetailed').value = d.detailed || '';
          document.getElementById('editPhotoType').value = d.photoType || '';
          document.getElementById('editComment').value = d.comment || '';
          document.getElementById('editModal').classList.remove('hidden');
        } else {
          showToast('Document not found.');
        }
      }).catch(e => {
        console.error(e);
        showToast('Error fetching document for edit.');
      }).finally(() => {
        hideSpinner();
      });
    }

    function closeModal() {
      document.getElementById('editModal').classList.add('hidden');
    }

    document.getElementById('saveEditBtn').addEventListener('click', async () => {
      if (!currentEditDocRef) {
        showToast('No document selected for edit.');
        return;
      }
      const updatedData = {
        vin: document.getElementById('editVin').value.trim().toUpperCase(),
        stock: document.getElementById('editStock').value.trim().toUpperCase(),
        make: document.getElementById('editMake').value.trim(),
        model: document.getElementById('editModel').value.trim(),
        year: document.getElementById('editYear').value,
        date: document.getElementById('editDate').value,
        detailed: document.getElementById('editDetailed').value,
        photoType: document.getElementById('editPhotoType').value,
        comment: document.getElementById('editComment').value.trim(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      const collectionName = document.getElementById('editCollection').value;
      if (collectionName === 'vehicles' && updatedData.photoType === 'Half Photos') {
        const existingData = (await currentEditDocRef.get()).data();
        updatedData.halfReason = existingData.halfReason || '';
      } else if (collectionName === 'vehicles' && updatedData.photoType !== 'Half Photos') {
        updatedData.halfReason = '';
      }
      showSpinner();
      try {
        await currentEditDocRef.update(updatedData);
        showToast('Changes saved!');
        closeModal();
      } catch (e) {
        console.error(e);
        showToast('Error saving changes.');
      } finally {
        hideSpinner();
      }
    });

    // ==========================
    // DELETE FUNCTION
    // ==========================
    async function deleteEntry(id, collectionName) {
      if (!confirm('Are you sure you want to delete this entry?')) return;
      showSpinner();
      try {
        await db.collection(collectionName).doc(id).delete();
        showToast('Entry deleted!');
      }
      catch (e) {
        console.error(e);
        showToast('Error deleting entry.');
      } finally {
        hideSpinner();
      }
    }

    // ==========================
    // FIREBASE LISTENERS
    // ==========================
    db.collection('pending_vehicles').onSnapshot(snapshot => {
      pendingData = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
      renderPending();
      document.getElementById('stock').dispatchEvent(new Event('input')); 
    }, err => {
      console.error(err);
      showToast('Error loading pending vehicles.');
    });

    db.collection('vehicles').onSnapshot(snapshot => {
      completedData = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
      document.getElementById('searchCompleted').dispatchEvent(new Event('input'));
      renderCompleted();
      renderDailySummary();
      hideSpinner();
    }, err => {
      console.error(err);
      showToast('Error loading completed vehicles.');
      hideSpinner();
    });

    // ==========================
    // INITIAL SETUP & EVENT LISTENERS
    // ==========================
    document.addEventListener('DOMContentLoaded', () => {
      setupSorting();
      const savedSearch = localStorage.getItem('completedSearch');
      if (savedSearch) {
          document.getElementById('searchCompleted').value = savedSearch;
      }
      document.getElementById('searchCompleted').dispatchEvent(new Event('input'));
      document.getElementById('stock').dispatchEvent(new Event('input'));
    });

    document.getElementById('searchCompleted').addEventListener('input', function() {
        localStorage.setItem('completedSearch', this.value);
        currentCompletedPage = 0;
        renderCompleted();
    });

    document.getElementById('stock').addEventListener('input', function() {
        const stockInput = this;
        const stockErrorSpan = document.getElementById('stockError');
        const stockValue = stockInput.value.trim().toUpperCase();
        stockInput.classList.remove('border-red-500');
        stockErrorSpan.classList.add('hidden');
        stockErrorSpan.textContent = '';
        if (stockValue.length > 0) {
            const isDuplicate = pendingData.some(item => item.data.stock.toUpperCase() === stockValue);
            if (isDuplicate) {
                stockInput.classList.add('border-red-500');
                stockErrorSpan.textContent = 'Stock number already in Pending list!';
                stockErrorSpan.classList.remove('hidden');
            }
        }
    });
  </script>
</body>
</html>
```